// ============================================================
// File: shaders/simple.comp
// Role: 첫 compute shader - SSBO 읽기/쓰기 검증
// Phase: 1-1 준비 단계
// ============================================================
#version 450

// ------------------------------------------------------------
// Workgroup 설정
// ------------------------------------------------------------
// local_size_x = 1개 스레드 (가우시안 1개 처리용)
// 나중에 N개 처리 시: local_size_x = 64 또는 256
// 
// 비유: 공장 작업대 1개, 작업자 1명
// 예시: local_size_x=64면 한 workgroup에서 64개 가우시안 병렬 처리
// ------------------------------------------------------------
layout(local_size_x = 1, local_size_y = 1, local_size_z = 1) in;

// ------------------------------------------------------------
// GaussianParam 구조체 (CPU 측 GaussianTypes.hpp와 동일해야 함)
// ------------------------------------------------------------
// std430: GPU 메모리 레이아웃 규칙
//   - vec3는 16바이트 정렬 (뒤에 float 붙으면 padding 없음)
//   - vec4는 16바이트 정렬
//
// 총 크기: 64 bytes (CPU와 일치해야 함!)
// ------------------------------------------------------------
struct GaussianParam {
    vec3 position;    // 12 bytes: 3D 위치
    float opacity;    //  4 bytes: 불투명도
    
    vec3 scale;       // 12 bytes: 스케일
    float _pad0;      //  4 bytes: padding
    
    vec4 rotation;    // 16 bytes: 쿼터니언 (w, x, y, z)
    
    vec3 color;       // 12 bytes: RGB
    float _pad1;      //  4 bytes: padding
};

// ------------------------------------------------------------
// SSBO 바인딩
// ------------------------------------------------------------
// binding = 0: 이 숫자는 CPU 측 descriptor와 매칭되어야 함
// 
// 학습 시 구조 (미리 설계):
//   binding 0: params[]      - 현재 파라미터 (read/write)
//   binding 1: grads[]       - gradient 저장 (Phase 2에서 추가)
//   binding 2: targets[]     - 타겟 이미지 (Phase 2에서 추가)
// ------------------------------------------------------------
layout(std430, binding = 0) buffer GaussianBuffer {
    GaussianParam params[];  // 가우시안 배열 (현재는 1개)
};

// ------------------------------------------------------------
// Main: 각 스레드가 가우시안 1개 처리
// ------------------------------------------------------------
void main() {
    // gl_GlobalInvocationID.x = 전역 스레드 인덱스
    // 예시: dispatch(N, 1, 1) 호출 시 x는 0 ~ N-1
    uint idx = gl_GlobalInvocationID.x;
    
    // ---------------------------------------------------------
    // Forward 연산 (Phase 1: 단순 테스트)
    // ---------------------------------------------------------
    // 지금: position.x += 1.0 (동작 확인용)
    // 나중: 3D→2D 투영, 공분산 계산 등
    //
    // 학습 고려: 이 결과값이 backward에서 필요하면
    //           별도 버퍼에 저장해야 함 (Phase 2에서 추가)
    // ---------------------------------------------------------
    params[idx].position.x += 1.0;
    
    // 색상도 살짝 변경 (다중 필드 수정 확인)
    params[idx].color.g += 0.5;
}